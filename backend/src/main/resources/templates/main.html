<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>메인 메뉴</title>
</head>
<body>
  <h2>메인 메뉴</h2>
  <div id="userInfo"></div>
  <button onclick="logout()">로그아웃</button>

  <h3>📂 바로가기 목록</h3>
  <ul id="shortcutList"></ul>

  <h3>➕ 바로가기 추가</h3>
  <form id="shortcutForm">
    이름: <input type="text" id="name" required><br>
    웹 주소 (URL): <input type="text" id="url" required><br>
    실행 파일 경로 (.exe) <small>(선택)</small>: <input type="text" id="exePath"><br>
    아이콘 이미지 업로드: <input type="file" id="iconUpload" accept="image/*"><br> <!-- ★ -->
    아이콘 파일 경로 (.ico) <small>(자동입력)</small>: <input type="text" id="iconPath" readonly><br> <!-- ★ -->
    <button type="submit">추가하기</button>
    <h4>🔍 아이콘 검색 (Iconfinder API)</h4>
    검색어: <input type="text" id="iconSearchInput">
    <button type="button" onclick="searchIcon()">검색</button>
    <div id="iconSearchResults" style="margin-top: 10px;"></div>
  </form>

  <script>
    async function fetchUserInfo() {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("로그인 필요");
        location.href = "/login";
        return;
      }

      const response = await fetch("/api/users/me", {
        headers: { "Authorization": "Bearer " + token }
      });

      if (response.ok) {
        const user = await response.json();
        document.getElementById("userInfo").innerText = `환영합니다, ${user.username}님!`;
        loadShortcuts();
      } else {
        alert("인증 실패. 다시 로그인해주세요.");
        localStorage.removeItem("token");
        location.href = "/login";
      }
    }

    async function loadShortcuts() {
      const token = localStorage.getItem("token");
      const response = await fetch(`/api/shortcuts`, {
        headers: { "Authorization": "Bearer " + token }
      });

      if (response.ok) {
        const shortcuts = await response.json();
        const list = document.getElementById("shortcutList");
        list.innerHTML = "";
        shortcuts.forEach(s => {
          const item = document.createElement("li");
          const icon = s.iconPath ? "🖼️" : "📄";
          item.innerHTML = `${icon} <strong>${s.name}</strong> → ${s.target}`;
          list.appendChild(item);
        });
      } else {
        console.error("바로가기 불러오기 실패:", response.status);
        alert("바로가기를 불러올 수 없습니다.");
      }
    }

    // ★ 아이콘 이미지 업로드 시 서버에 전송하고 .ico 경로를 자동입력
    document.getElementById("iconUpload").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("image", file);

      const token = localStorage.getItem("token"); // ✅ 토큰 불러오기

      try {
        const response = await fetch("/api/icons/upload", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token // ✅ 토큰 포함
          },
          body: formData
        });

        if (response.ok) {
          const iconPath = await response.text();
          document.getElementById("iconPath").value = iconPath;
          alert("🖼 아이콘 변환 완료!");
        } else {
          const err = await response.text();
          console.error("아이콘 변환 실패:", err);
          alert("아이콘 변환 실패: " + err); // ❗추가된 에러 메시지
        }
      } catch (e) {
        console.error("에러:", e);
        alert("네트워크 오류로 아이콘 업로드 실패");
      }
    });


    document.getElementById("shortcutForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const token = localStorage.getItem("token");

      const body = {
        name: document.getElementById("name").value,
        url: document.getElementById("url").value,
        exePath: document.getElementById("exePath").value || null,
        iconPath: document.getElementById("iconPath").value || null
      };

      const response = await fetch(`/api/shortcuts/create`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if (response.ok) {
        alert("바로가기 생성 완료");
        loadShortcuts();
        document.getElementById("shortcutForm").reset();
        document.getElementById("iconPath").value = "";
      } else {
        const error = await response.text();
        console.error("생성 실패:", error);
        alert("바로가기 생성 실패: " + error);
      }
    });

    function logout() {
      localStorage.removeItem("token");
      location.href = "/login";
    }

    fetchUserInfo();
  </script>

  <script>
  async function searchIcon() {
    const query = document.getElementById("iconSearchInput").value.trim();
    if (!query) return alert("검색어를 입력하세요.");

    const token = localStorage.getItem("token");
    const response = await fetch(`/api/icons/search?query=${encodeURIComponent(query)}`, {
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    const container = document.getElementById("iconSearchResults");
    container.innerHTML = "";

    if (!response.ok) {
      container.innerText = "아이콘 검색 실패";
      return;
    }

    const icons = await response.json();

    icons.forEach(icon => {
      const img = document.createElement("img");
      img.src = icon.previewUrl;
      img.alt = icon.tags.join(", ");
      img.style.width = "64px";
      img.style.margin = "5px";
      img.style.cursor = "pointer";

      img.onclick = async () => {
        if (!confirm("이 아이콘을 선택하시겠습니까?")) return;

        const formData = new FormData();
        formData.append("imageUrl", icon.previewUrl);

        const uploadRes = await fetch("/api/icons/url-upload", {
          method: "POST",
          headers: { "Authorization": "Bearer " + token },
          body: formData
        });

        if (uploadRes.ok) {
          const iconPath = await uploadRes.text();
          document.getElementById("iconPath").value = iconPath;
          alert("🖼️ 아이콘 변환 완료!");
        } else {
          alert("아이콘 저장 실패");
        }
      };

      container.appendChild(img);
    });
  }
  </script>

</body>
</html>
