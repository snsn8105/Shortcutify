<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë©”ì¸ ë©”ë‰´</title>
</head>
<body>
  <h2>ë©”ì¸ ë©”ë‰´</h2>
  <div id="userInfo"></div>
  <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>

  <h3>ğŸ“‚ ë°”ë¡œê°€ê¸° ëª©ë¡</h3>
  <ul id="shortcutList"></ul>

  <h3>â• ë°”ë¡œê°€ê¸° ì¶”ê°€</h3>
  <form id="shortcutForm">
    ì´ë¦„: <input type="text" id="name" required><br>
    ì›¹ ì£¼ì†Œ (URL): <input type="text" id="url" required><br>
    ì‹¤í–‰ íŒŒì¼ ê²½ë¡œ (.exe) <small>(ì„ íƒ)</small>: <input type="text" id="exePath"><br>
    ì•„ì´ì½˜ ì´ë¯¸ì§€ ì—…ë¡œë“œ: <input type="file" id="iconUpload" accept="image/*"><br> <!-- â˜… -->
    ì•„ì´ì½˜ íŒŒì¼ ê²½ë¡œ (.ico) <small>(ìë™ì…ë ¥)</small>: <input type="text" id="iconPath" readonly><br> <!-- â˜… -->
    <button type="submit">ì¶”ê°€í•˜ê¸°</button>
    <h4>ğŸ” ì•„ì´ì½˜ ê²€ìƒ‰ (Iconfinder API)</h4>
    ê²€ìƒ‰ì–´: <input type="text" id="iconSearchInput">
    <button type="button" onclick="searchIcon()">ê²€ìƒ‰</button>
    <div id="iconSearchResults" style="margin-top: 10px;"></div>
  </form>

  <script>
    async function fetchUserInfo() {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("ë¡œê·¸ì¸ í•„ìš”");
        location.href = "/login";
        return;
      }

      const response = await fetch("/api/users/me", {
        headers: { "Authorization": "Bearer " + token }
      });

      if (response.ok) {
        const user = await response.json();
        document.getElementById("userInfo").innerText = `í™˜ì˜í•©ë‹ˆë‹¤, ${user.username}ë‹˜!`;
        loadShortcuts();
      } else {
        alert("ì¸ì¦ ì‹¤íŒ¨. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        localStorage.removeItem("token");
        location.href = "/login";
      }
    }

    async function loadShortcuts() {
      const token = localStorage.getItem("token");
      const response = await fetch(`/api/shortcuts`, {
        headers: { "Authorization": "Bearer " + token }
      });

      if (response.ok) {
        const shortcuts = await response.json();
        const list = document.getElementById("shortcutList");
        list.innerHTML = "";
        shortcuts.forEach(s => {
          const item = document.createElement("li");
          const icon = s.iconPath ? "ğŸ–¼ï¸" : "ğŸ“„";
          item.innerHTML = `${icon} <strong>${s.name}</strong> â†’ ${s.target}`;
          list.appendChild(item);
        });
      } else {
        console.error("ë°”ë¡œê°€ê¸° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", response.status);
        alert("ë°”ë¡œê°€ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      }
    }

    // â˜… ì•„ì´ì½˜ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ì„œë²„ì— ì „ì†¡í•˜ê³  .ico ê²½ë¡œë¥¼ ìë™ì…ë ¥
    document.getElementById("iconUpload").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("image", file);

      const token = localStorage.getItem("token"); // âœ… í† í° ë¶ˆëŸ¬ì˜¤ê¸°

      try {
        const response = await fetch("/api/icons/upload", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token // âœ… í† í° í¬í•¨
          },
          body: formData
        });

        if (response.ok) {
          const iconPath = await response.text();
          document.getElementById("iconPath").value = iconPath;
          alert("ğŸ–¼ ì•„ì´ì½˜ ë³€í™˜ ì™„ë£Œ!");
        } else {
          const err = await response.text();
          console.error("ì•„ì´ì½˜ ë³€í™˜ ì‹¤íŒ¨:", err);
          alert("ì•„ì´ì½˜ ë³€í™˜ ì‹¤íŒ¨: " + err); // â—ì¶”ê°€ëœ ì—ëŸ¬ ë©”ì‹œì§€
        }
      } catch (e) {
        console.error("ì—ëŸ¬:", e);
        alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì•„ì´ì½˜ ì—…ë¡œë“œ ì‹¤íŒ¨");
      }
    });


    document.getElementById("shortcutForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const token = localStorage.getItem("token");

      const body = {
        name: document.getElementById("name").value,
        url: document.getElementById("url").value,
        exePath: document.getElementById("exePath").value || null,
        iconPath: document.getElementById("iconPath").value || null
      };

      const response = await fetch(`/api/shortcuts/create`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if (response.ok) {
        alert("ë°”ë¡œê°€ê¸° ìƒì„± ì™„ë£Œ");
        loadShortcuts();
        document.getElementById("shortcutForm").reset();
        document.getElementById("iconPath").value = "";
      } else {
        const error = await response.text();
        console.error("ìƒì„± ì‹¤íŒ¨:", error);
        alert("ë°”ë¡œê°€ê¸° ìƒì„± ì‹¤íŒ¨: " + error);
      }
    });

    function logout() {
      localStorage.removeItem("token");
      location.href = "/login";
    }

    fetchUserInfo();
  </script>

  <script>
  async function searchIcon() {
    const query = document.getElementById("iconSearchInput").value.trim();
    if (!query) return alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

    const token = localStorage.getItem("token");
    const response = await fetch(`/api/icons/search?query=${encodeURIComponent(query)}`, {
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    const container = document.getElementById("iconSearchResults");
    container.innerHTML = "";

    if (!response.ok) {
      container.innerText = "ì•„ì´ì½˜ ê²€ìƒ‰ ì‹¤íŒ¨";
      return;
    }

    const icons = await response.json();

    icons.forEach(icon => {
      const img = document.createElement("img");
      img.src = icon.previewUrl;
      img.alt = icon.tags.join(", ");
      img.style.width = "64px";
      img.style.margin = "5px";
      img.style.cursor = "pointer";

      img.onclick = async () => {
        if (!confirm("ì´ ì•„ì´ì½˜ì„ ì„ íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const formData = new FormData();
        formData.append("imageUrl", icon.previewUrl);

        const uploadRes = await fetch("/api/icons/url-upload", {
          method: "POST",
          headers: { "Authorization": "Bearer " + token },
          body: formData
        });

        if (uploadRes.ok) {
          const iconPath = await uploadRes.text();
          document.getElementById("iconPath").value = iconPath;
          alert("ğŸ–¼ï¸ ì•„ì´ì½˜ ë³€í™˜ ì™„ë£Œ!");
        } else {
          alert("ì•„ì´ì½˜ ì €ì¥ ì‹¤íŒ¨");
        }
      };

      container.appendChild(img);
    });
  }
  </script>

</body>
</html>
